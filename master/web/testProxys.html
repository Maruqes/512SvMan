<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>512SvMan Proxy Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#fb923c',
                            base: '#f97316',
                            dark: '#ea580c'
                        }
                    }
                }
            }
        };
    </script>
</head>
<body class="min-h-screen bg-slate-950 bg-[radial-gradient(circle_at_top,_rgba(249,115,22,0.18),_transparent_55%)] text-slate-100 flex justify-center p-6 sm:p-8">
    <main class="w-full max-w-6xl space-y-6">
        <header class="rounded-2xl border border-slate-800/70 bg-slate-900/70 backdrop-blur-sm p-6 sm:p-8 shadow-xl space-y-4">
            <div class="space-y-2">
                <h1 class="text-3xl font-semibold tracking-[0.25em] uppercase">512SvMan // Proxy Lab</h1>
                <p class="text-sm text-slate-400">Define o token, inspeciona os hosts e ajusta tudo com controlo fino.</p>
            </div>
            <form id="tokenForm" class="grid gap-3 sm:grid-cols-[max-content_1fr] sm:items-center sm:gap-4">
                <label for="tokenInput" class="text-xs uppercase tracking-[0.2em] text-slate-400">Login token</label>
                <div class="flex flex-col gap-2 sm:flex-row">
                    <input id="tokenInput" type="text" placeholder="cola aqui o token" autocomplete="off" spellcheck="false" class="w-full min-w-[220px] rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm text-slate-100 shadow-inner outline-none transition focus:border-brand-base">
                    <div class="flex gap-2 sm:flex-none">
                        <button type="submit" class="flex-1 rounded-xl bg-gradient-to-r from-brand-dark to-brand-base px-4 py-2 text-sm font-semibold text-slate-950 shadow transition hover:shadow-lg hover:brightness-[1.05]">Guardar token</button>
                        <button type="button" id="clearToken" class="flex-1 rounded-xl border border-slate-700/70 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800/80">Limpar</button>
                    </div>
                </div>
            </form>
            <div id="tokenStatus" class="text-sm text-slate-500">Token ainda nao definido.</div>
        </header>

        <section class="grid gap-6 lg:grid-cols-[2fr_1.1fr]">
            <section class="space-y-4 rounded-2xl border border-slate-800/70 bg-slate-900/60 p-6 shadow-lg">
                <div class="flex flex-wrap items-center gap-3">
                    <h2 class="flex-1 text-xl font-semibold">Inventario de proxies</h2>
                    <div class="flex gap-2">
                        <button type="button" id="refreshList" class="rounded-xl bg-gradient-to-r from-brand-dark to-brand-base px-4 py-2 text-sm font-semibold text-slate-950 transition hover:shadow-lg">Atualizar lista</button>
                        <button type="button" id="resetFilters" class="rounded-xl border border-slate-700/70 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800/80">Limpar selecao</button>
                    </div>
                </div>
                <div class="overflow-hidden rounded-2xl border border-slate-800/60">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-800 text-sm">
                            <thead class="bg-slate-900/80 text-xs uppercase tracking-[0.2em] text-slate-400">
                                <tr>
                                    <th class="px-4 py-3 text-left">ID</th>
                                    <th class="px-4 py-3 text-left">Dominios</th>
                                    <th class="px-4 py-3 text-left">Destino</th>
                                    <th class="px-4 py-3 text-left">Estado</th>
                                    <th class="px-4 py-3 text-left">Acoes</th>
                                </tr>
                            </thead>
                            <tbody id="proxiesBody" class="divide-y divide-slate-800/70">
                                <tr>
                                    <td colspan="5" class="px-4 py-6 text-center text-xs text-slate-500">Ainda sem dados. Carrega em "Atualizar lista".</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="space-y-4 rounded-2xl border border-slate-800/70 bg-slate-900/60 p-6 shadow-lg">
                <h2 id="formTitle" class="text-xl font-semibold">Criar novo proxy</h2>
                <form id="proxyForm" class="space-y-5 text-sm">
                    <div class="space-y-2">
                        <label for="domainsInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Dominios (virgulas ou linhas)</label>
                        <textarea id="domainsInput" placeholder="ex: site.exemplo.com, api.exemplo.com" class="w-full min-h-[82px] rounded-xl border border-transparent bg-slate-950/60 px-4 py-3 text-sm outline-none transition focus:border-brand-base"></textarea>
                    </div>

                    <div class="grid gap-3 sm:grid-cols-3">
                        <div class="space-y-2">
                            <label for="schemeInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Forward scheme</label>
                            <select id="schemeInput" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                                <option value="http">http</option>
                                <option value="https">https</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="hostInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Forward host</label>
                            <input id="hostInput" type="text" placeholder="ex: 192.168.1.10" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                        </div>
                        <div class="space-y-2">
                            <label for="portInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Forward port</label>
                            <input id="portInput" type="number" min="1" max="65535" value="80" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                        </div>
                    </div>

                    <div class="grid gap-3 sm:grid-cols-2">
                        <div class="space-y-2">
                            <label for="accessListInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Access list ID</label>
                            <input id="accessListInput" type="text" value="0" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                        </div>
                        <div class="space-y-2">
                            <label for="certificateInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Certificate ID</label>
                            <input id="certificateInput" type="number" min="0" value="0" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="advancedInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Advanced config</label>
                        <textarea id="advancedInput" placeholder="# custom directives" class="w-full min-h-[82px] rounded-xl border border-transparent bg-slate-950/60 px-4 py-3 text-sm outline-none transition focus:border-brand-base"></textarea>
                    </div>

                    <div class="space-y-2">
                        <label for="metaInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Meta (JSON)</label>
                        <textarea id="metaInput" placeholder='{"letsencrypt_agree":false,"dns_challenge":false}' class="w-full min-h-[82px] rounded-xl border border-transparent bg-slate-950/60 px-4 py-3 text-sm outline-none transition focus:border-brand-base"></textarea>
                    </div>

                    <div class="space-y-2">
                        <label for="locationsInput" class="text-xs uppercase tracking-[0.18em] text-slate-400">Locations (JSON)</label>
                        <textarea id="locationsInput" placeholder="[]" class="w-full min-h-[82px] rounded-xl border border-transparent bg-slate-950/60 px-4 py-3 text-sm outline-none transition focus:border-brand-base"></textarea>
                    </div>

                    <div class="grid gap-3 sm:grid-cols-2">
                        <label class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-2 text-sm text-slate-200">
                            <input id="cacheToggle" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900" checked>
                            Cache ativo
                        </label>
                        <label class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-2 text-sm text-slate-200">
                            <input id="exploitToggle" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900" checked>
                            Bloquear exploits
                        </label>
                        <label class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-2 text-sm text-slate-200">
                            <input id="wsToggle" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900" checked>
                            Websocket
                        </label>
                        <label class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-2 text-sm text-slate-200">
                            <input id="http2Toggle" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900">
                            HTTP/2
                        </label>
                        <label class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-2 text-sm text-slate-200">
                            <input id="hstsToggle" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900">
                            HSTS
                        </label>
                        <label class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-2 text-sm text-slate-200">
                            <input id="subdomainsToggle" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900">
                            HSTS subdominios
                        </label>
                        <label class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-950/60 px-4 py-2 text-sm text-slate-200">
                            <input id="sslForcedToggle" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900">
                            Forcar SSL
                        </label>
                    </div>

                    <div class="flex flex-col gap-2 sm:flex-row">
                        <button type="submit" id="submitButton" class="flex-1 rounded-xl bg-gradient-to-r from-brand-dark to-brand-base px-4 py-2 font-semibold text-slate-950 transition hover:shadow-lg">Criar proxy</button>
                        <button type="button" id="cancelEdit" class="hidden flex-1 rounded-xl border border-slate-700/70 px-4 py-2 font-semibold text-slate-100 transition hover:bg-slate-800/80">Cancelar edicao</button>
                    </div>
                </form>
            </section>
        </section>

        <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-6 shadow-lg">
            <h2 class="text-xl font-semibold">Console</h2>
            <div id="console" class="mt-4 h-64 overflow-y-auto rounded-2xl bg-slate-950/70 p-4 font-mono text-xs leading-relaxed text-slate-300"></div>
        </section>
    </main>

    <script>
        (function () {
            const STORAGE_KEY = "proxy-panel-token";
            const state = {
                token: localStorage.getItem(STORAGE_KEY) || "",
                editingId: null,
                proxys: []
            };

            const refs = {
                tokenForm: document.getElementById("tokenForm"),
                tokenInput: document.getElementById("tokenInput"),
                tokenStatus: document.getElementById("tokenStatus"),
                clearToken: document.getElementById("clearToken"),
                refreshList: document.getElementById("refreshList"),
                resetFilters: document.getElementById("resetFilters"),
                proxiesBody: document.getElementById("proxiesBody"),
                console: document.getElementById("console"),
                proxyForm: document.getElementById("proxyForm"),
                formTitle: document.getElementById("formTitle"),
                submitButton: document.getElementById("submitButton"),
                cancelEdit: document.getElementById("cancelEdit"),
                domains: document.getElementById("domainsInput"),
                scheme: document.getElementById("schemeInput"),
                host: document.getElementById("hostInput"),
                port: document.getElementById("portInput"),
                accessList: document.getElementById("accessListInput"),
                certificate: document.getElementById("certificateInput"),
                advanced: document.getElementById("advancedInput"),
                meta: document.getElementById("metaInput"),
                locations: document.getElementById("locationsInput"),
                cacheToggle: document.getElementById("cacheToggle"),
                exploitToggle: document.getElementById("exploitToggle"),
                wsToggle: document.getElementById("wsToggle"),
                http2Toggle: document.getElementById("http2Toggle"),
                hstsToggle: document.getElementById("hstsToggle"),
                subdomainsToggle: document.getElementById("subdomainsToggle"),
                sslForcedToggle: document.getElementById("sslForcedToggle")
            };

            const defaults = {
                meta: {
                    letsencrypt_agree: false,
                    dns_challenge: false
                }
            };

            refs.tokenInput.value = state.token;
            updateTokenStatus();
            resetForm();
            log("Interface carregada. Define o token para comecar.\n");

            refs.tokenForm.addEventListener("submit", function (event) {
                event.preventDefault();
                persistToken(refs.tokenInput.value);
            });

            refs.clearToken.addEventListener("click", function () {
                persistToken("");
            });

            refs.refreshList.addEventListener("click", function () {
                fetchProxies();
            });

            refs.resetFilters.addEventListener("click", function () {
                resetForm();
                log("Formulario limpo. Pronto para criar um novo proxy.\n");
            });

            refs.cancelEdit.addEventListener("click", function () {
                resetForm();
                log("Modo de edicao cancelado.\n");
            });

            refs.proxyForm.addEventListener("submit", function (event) {
                event.preventDefault();
                if (!ensureToken()) {
                    return;
                }

                const payload = buildPayloadFromForm();
                if (!payload) {
                    return;
                }

                if (state.editingId !== null) {
                    payload.id = state.editingId;
                    apiRequest("/proxy/edit", { method: "PUT", body: payload })
                        .then(function () {
                            log(`[OK] Proxy ${state.editingId} editado com sucesso.\n`);
                            resetForm();
                            fetchProxies();
                        })
                        .catch(handleError);
                } else {
                    apiRequest("/proxy/create", { method: "POST", body: payload })
                        .then(function (result) {
                            const createdId = result && result.id ? result.id : "?";
                            log(`[OK] Proxy criado (id ${createdId}).\n`);
                            resetForm();
                            fetchProxies();
                        })
                        .catch(handleError);
                }
            });

            refs.proxiesBody.addEventListener("click", function (event) {
                const button = event.target.closest("button[data-action]");
                if (!button) {
                    return;
                }

                const row = button.closest("tr[data-id]");
                if (!row) {
                    return;
                }
                const id = Number(row.getAttribute("data-id"));
                const proxy = state.proxys.find(function (item) { return item.id === id; });
                if (!proxy) {
                    log(`[ERRO] Proxy ${id} nao encontrado em memoria. Atualiza a lista.\n`);
                    return;
                }

                const action = button.getAttribute("data-action");
                if (action === "edit") {
                    enterEditMode(proxy);
                } else if (action === "delete") {
                    if (confirm(`Apagar o proxy ${id}?`)) {
                        apiRequest("/proxy/delete", { method: "DELETE", body: { id: id } })
                            .then(function () {
                                log(`[DEL] Proxy ${id} eliminado.\n`);
                                fetchProxies();
                            })
                            .catch(handleError);
                    }
                } else if (action === "toggle") {
                    const enabled = Boolean(proxy.enabled);
                    const endpoint = enabled ? "/proxy/disable" : "/proxy/enable";
                    apiRequest(endpoint, { method: "POST", body: { id: id } })
                        .then(function () {
                            log(`[OK] Proxy ${id} ${enabled ? "desativado" : "ativado"}.\n`);
                            fetchProxies();
                        })
                        .catch(handleError);
                }
            });

            function persistToken(rawToken) {
                state.token = rawToken.trim();
                if (state.token) {
                    localStorage.setItem(STORAGE_KEY, state.token);
                    log("[TOKEN] Token guardado.\n");
                } else {
                    localStorage.removeItem(STORAGE_KEY);
                    log("[ALERTA] Token limpo.\n");
                }
                refs.tokenInput.value = state.token;
                updateTokenStatus();
            }

            function ensureToken() {
                if (!state.token) {
                    log("[ALERTA] Define primeiro o token antes de chamar a API.\n");
                    return false;
                }
                return true;
            }

            function updateTokenStatus() {
                if (state.token) {
                    refs.tokenStatus.textContent = "Token carregado e pronto a usar.";
                    refs.tokenStatus.classList.remove("text-slate-500");
                    refs.tokenStatus.classList.add("text-emerald-400");
                } else {
                    refs.tokenStatus.textContent = "Token ainda nao definido.";
                    refs.tokenStatus.classList.remove("text-emerald-400");
                    refs.tokenStatus.classList.add("text-slate-500");
                }
            }

            function fetchProxies() {
                if (!ensureToken()) {
                    return;
                }
                log("[INFO] A pedir lista de proxies...\n");
                apiRequest("/proxy/list", { method: "GET" })
                    .then(function (proxys) {
                        const clean = Array.isArray(proxys) ? proxys : [];
                        state.proxys = clean;
                        renderProxies(clean);
                        log(`[INFO] Recebidos ${clean.length} proxies.\n`);
                    })
                    .catch(handleError);
            }

            function renderProxies(proxys) {
                if (!proxys.length) {
                    refs.proxiesBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-xs text-slate-500">Sem proxies para mostrar.</td></tr>';
                    return;
                }

                refs.proxiesBody.innerHTML = proxys.map(function (proxy) {
                    const id = proxy.id;
                    const domains = Array.isArray(proxy.domain_names) ? proxy.domain_names : [];
                    const prettyDomains = domains.map(escapeHTML).join('<br>');
                    const target = `${escapeHTML(proxy.forward_scheme || 'http')}://${escapeHTML(proxy.forward_host || '-')}:${escapeHTML(proxy.forward_port || '-')}`;
                    const enabled = Boolean(proxy.enabled);
                    const statusChip = enabled
                        ? '<span class="inline-flex items-center rounded-full border border-amber-400/40 bg-amber-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.2em] text-amber-300">Online</span>'
                        : '<span class="inline-flex items-center rounded-full border border-red-400/40 bg-red-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.2em] text-red-300">Offline</span>';
                    const toggleLabel = enabled ? 'Desativar' : 'Ativar';
                    return `
                        <tr data-id="${id}" class="transition hover:bg-slate-800/70">
                            <td class="px-4 py-3 text-sm text-slate-300">#${escapeHTML(id)}</td>
                            <td class="px-4 py-3 text-sm text-slate-100">${prettyDomains || '<span class="text-slate-500">(sem dominios)</span>'}</td>
                            <td class="px-4 py-3 text-sm text-slate-300">${target}</td>
                            <td class="px-4 py-3">${statusChip}</td>
                            <td class="px-4 py-3">
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" data-action="edit" class="rounded-xl bg-gradient-to-r from-brand-dark to-brand-base px-3 py-2 text-xs font-semibold text-slate-950 transition hover:shadow-lg">Editar</button>
                                    <button type="button" data-action="toggle" class="rounded-xl border border-slate-700/70 px-3 py-2 text-xs font-semibold text-slate-100 transition hover:bg-slate-800/80">${toggleLabel}</button>
                                    <button type="button" data-action="delete" class="rounded-xl bg-gradient-to-r from-red-600 to-red-500 px-3 py-2 text-xs font-semibold text-white transition hover:shadow-lg">Apagar</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function enterEditMode(proxy) {
                state.editingId = proxy.id;
                refs.formTitle.textContent = `Editar proxy #${proxy.id}`;
                refs.submitButton.textContent = "Guardar alteracoes";
                refs.cancelEdit.classList.remove("hidden");

                refs.domains.value = Array.isArray(proxy.domain_names) ? proxy.domain_names.join("\n") : "";
                refs.scheme.value = proxy.forward_scheme || "http";
                refs.host.value = proxy.forward_host || "";
                refs.port.value = proxy.forward_port || 80;
                refs.accessList.value = proxy.access_list_id ? String(proxy.access_list_id) : "0";
                refs.certificate.value = proxy.certificate_id || 0;
                refs.advanced.value = proxy.advanced_config || "";
                refs.meta.value = JSON.stringify(proxy.meta || defaults.meta, null, 2);
                refs.locations.value = JSON.stringify(proxy.locations || [], null, 2);
                refs.cacheToggle.checked = Boolean(proxy.caching_enabled);
                refs.exploitToggle.checked = Boolean(proxy.block_exploits);
                refs.wsToggle.checked = Boolean(proxy.allow_websocket_upgrade);
                refs.http2Toggle.checked = Boolean(proxy.http2_support);
                refs.hstsToggle.checked = Boolean(proxy.hsts_enabled);
                refs.subdomainsToggle.checked = Boolean(proxy.hsts_subdomains);
                refs.sslForcedToggle.checked = Boolean(proxy.ssl_forced);

                refs.proxyForm.scrollIntoView({ behavior: "smooth", block: "start" });
                log(`[INFO] A editar proxy ${proxy.id}.\n`);
            }

            function resetForm() {
                state.editingId = null;
                refs.formTitle.textContent = "Criar novo proxy";
                refs.submitButton.textContent = "Criar proxy";
                refs.cancelEdit.classList.add("hidden");
                refs.proxyForm.reset();
                refs.port.value = 80;
                refs.accessList.value = "0";
                refs.certificate.value = "0";
                refs.meta.value = JSON.stringify(defaults.meta, null, 2);
                refs.locations.value = "[]";
                refs.cacheToggle.checked = true;
                refs.exploitToggle.checked = true;
                refs.wsToggle.checked = true;
                refs.http2Toggle.checked = false;
                refs.hstsToggle.checked = false;
                refs.subdomainsToggle.checked = false;
                refs.sslForcedToggle.checked = false;
            }

            function buildPayloadFromForm() {
                const domainLines = refs.domains.value
                    .split(/[\n,]/)
                    .map(function (part) { return part.trim(); })
                    .filter(Boolean);

                if (!domainLines.length) {
                    log("[ALERTA] Indica pelo menos um dominio.\n");
                    return null;
                }

                const host = refs.host.value.trim();
                if (!host) {
                    log("[ALERTA] O host de destino e obrigatorio.\n");
                    return null;
                }

                const port = Number(refs.port.value);
                if (!Number.isInteger(port) || port < 1 || port > 65535) {
                    log("[ALERTA] Porto invalido.\n");
                    return null;
                }

                let meta;
                let locations;
                try {
                    meta = refs.meta.value.trim() ? JSON.parse(refs.meta.value) : defaults.meta;
                } catch (error) {
                    log("[ERRO] Meta deve ser JSON valido.\n");
                    return null;
                }

                try {
                    locations = refs.locations.value.trim() ? JSON.parse(refs.locations.value) : [];
                } catch (error) {
                    log("[ERRO] Locations deve ser JSON valido (normalmente uma lista).\n");
                    return null;
                }

                const payload = {
                    domain_names: domainLines,
                    forward_scheme: refs.scheme.value,
                    forward_host: host,
                    forward_port: port,
                    caching_enabled: Boolean(refs.cacheToggle.checked),
                    block_exploits: Boolean(refs.exploitToggle.checked),
                    allow_websocket_upgrade: Boolean(refs.wsToggle.checked),
                    access_list_id: String(refs.accessList.value || "0"),
                    certificate_id: Number(refs.certificate.value || 0),
                    meta: meta,
                    advanced_config: refs.advanced.value,
                    locations: locations,
                    http2_support: Boolean(refs.http2Toggle.checked),
                    hsts_enabled: Boolean(refs.hstsToggle.checked),
                    hsts_subdomains: Boolean(refs.subdomainsToggle.checked),
                    ssl_forced: Boolean(refs.sslForcedToggle.checked)
                };

                return payload;
            }

            function apiRequest(path, options) {
                const config = {
                    method: options.method || "GET",
                    headers: {
                        Authorization: state.token
                    }
                };

                if (options.body) {
                    config.headers["Content-Type"] = "application/json";
                    config.body = JSON.stringify(options.body);
                }

                return fetch(path, config).then(async function (response) {
                    const text = await response.text();
                    let parsed = null;
                    if (text) {
                        try {
                            parsed = JSON.parse(text);
                        } catch (error) {
                            parsed = text;
                        }
                    }

                    if (!response.ok) {
                        const message = parsed && parsed.error ? parsed.error : parsed || response.statusText;
                        throw new Error(message || "Erro inesperado");
                    }

                    return parsed;
                });
            }

            function handleError(error) {
                log(`[ERRO] ${error && error.message ? error.message : error}\n`);
            }

            function log(message) {
                refs.console.textContent += message;
                refs.console.scrollTop = refs.console.scrollHeight;
            }

            function escapeHTML(value) {
                return String(value)
                    .replace(/&/g, "&amp;")
                    .replace(/"/g, "&quot;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            if (state.token) {
                fetchProxies();
            }
        })();
    </script>
</body>
</html>
