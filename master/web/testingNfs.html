<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>512SvMan NFS Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            base: '#38bdf8',
                            dark: '#0ea5e9'
                        }
                    }
                }
            }
        };
    </script>
</head>
<body class="min-h-screen bg-slate-950 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.24),_transparent_55%)] text-slate-100 flex justify-center p-6 sm:p-8">
    <main class="w-full max-w-6xl space-y-6">
        <header class="rounded-2xl border border-slate-800/70 bg-slate-900/70 backdrop-blur-sm p-6 sm:p-8 shadow-lg space-y-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-semibold tracking-wider">512SvMan // Painel de NFS</h1>
                <p class="mt-2 text-sm text-slate-400">Injeta o token, gere partilhas, acompanha o log – tudo num só lugar.</p>
            </div>
            <form id="tokenForm" class="grid gap-3 sm:grid-cols-[max-content_1fr] sm:items-center sm:gap-4">
                <label for="tokenInput" class="text-xs uppercase tracking-[0.2em] text-slate-400">Login token</label>
                <div class="flex flex-col gap-2 sm:flex-row">
                    <input id="tokenInput" type="text" placeholder="cola aqui o token" autocomplete="off" spellcheck="false" class="w-full min-w-[220px] rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm text-slate-100 shadow-inner outline-none transition focus:border-brand-base">
                    <div class="flex gap-2 sm:flex-none">
                        <button type="submit" class="flex-1 rounded-xl bg-gradient-to-r from-brand-dark to-brand-base px-4 py-2 text-sm font-semibold text-slate-950 shadow hover:shadow-lg hover:brightness-[1.05] transition">Guardar token</button>
                        <button type="button" id="limparToken" class="flex-1 rounded-xl border border-slate-700/70 px-4 py-2 text-sm font-semibold text-slate-200 hover:bg-slate-800/70 transition">Limpar</button>
                    </div>
                </div>
            </form>
            <div id="tokenStatus" class="text-sm text-slate-500">Token ainda nao definido.</div>
        </header>

        <section class="grid gap-6 lg:grid-cols-3">
            <section class="lg:col-span-3 space-y-4 rounded-2xl border border-slate-800/70 bg-slate-900/60 p-6 shadow-lg">
                <div class="flex flex-wrap items-center gap-3">
                    <h2 class="flex-1 text-xl font-semibold">Partilhas ativas</h2>
                    <button id="refreshShares" class="rounded-xl bg-gradient-to-r from-brand-dark to-brand-base px-4 py-2 text-sm font-semibold text-slate-950 transition hover:shadow-lg">Atualizar lista</button>
                </div>
                <div class="overflow-hidden rounded-2xl border border-slate-800/60">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-800 text-sm">
                            <thead class="bg-slate-900/80 text-xs uppercase tracking-[0.2em] text-slate-400">
                                <tr>
                                    <th class="px-4 py-3 text-left">Machine</th>
                                    <th class="px-4 py-3 text-left">Folder</th>
                                    <th class="px-4 py-3 text-left">Source</th>
                                    <th class="px-4 py-3 text-left">Mount</th>
                                </tr>
                            </thead>
                            <tbody id="sharesBody" class="divide-y divide-slate-800/70">
                                <tr>
                                    <td colspan="4" class="px-4 py-6 text-center text-xs text-slate-500">Ainda sem dados. Carrega em "Atualizar lista".</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="space-y-4 rounded-2xl border border-slate-800/70 bg-slate-900/60 p-6 shadow-lg">
                <h2 class="text-lg font-semibold">Criar nova partilha</h2>
                <form id="createForm" class="space-y-4 text-sm">
                    <div class="space-y-2">
                        <label for="createMachine" class="text-xs uppercase tracking-[0.18em] text-slate-400">Nome da maquina</label>
                        <input id="createMachine" type="text" placeholder="ex: worker-01" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                    </div>
                    <div class="space-y-2">
                        <label for="createFolder" class="text-xs uppercase tracking-[0.18em] text-slate-400">Path na maquina</label>
                        <input id="createFolder" type="text" placeholder="ex: /var/data/projects" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                    </div>
                    <button type="submit" class="w-full rounded-xl bg-gradient-to-r from-brand-dark to-brand-base px-4 py-2 font-semibold text-slate-950 transition hover:shadow-lg">Criar partilha</button>
                </form>
            </section>

            <section class="space-y-4 rounded-2xl border border-slate-800/70 bg-slate-900/60 p-6 shadow-lg">
                <h2 class="text-lg font-semibold">Remover partilha</h2>
                <form id="deleteForm" class="space-y-4 text-sm">
                    <div class="space-y-2">
                        <label for="deleteMachine" class="text-xs uppercase tracking-[0.18em] text-slate-400">Nome da maquina</label>
                        <input id="deleteMachine" type="text" placeholder="ex: worker-01" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                    </div>
                    <div class="space-y-2">
                        <label for="deleteFolder" class="text-xs uppercase tracking-[0.18em] text-slate-400">Path na maquina</label>
                        <input id="deleteFolder" type="text" placeholder="ex: /var/data/projects" class="w-full rounded-xl border border-transparent bg-slate-950/60 px-4 py-2 text-sm outline-none transition focus:border-brand-base">
                    </div>
                    <button type="submit" class="w-full rounded-xl border border-slate-700/70 px-4 py-2 font-semibold text-slate-100 transition hover:bg-slate-800/80">Remover partilha</button>
                </form>
            </section>
        </section>

        <section class="rounded-2xl border border-slate-800/70 bg-slate-900/60 p-6 shadow-lg">
            <h2 class="text-lg font-semibold">Console</h2>
            <pre id="console" class="mt-4 h-64 overflow-y-auto rounded-2xl bg-slate-950/70 p-4 font-mono text-xs leading-relaxed text-slate-300"></pre>
        </section>
    </main>

    <script>
        (function () {
            const state = {
                token: localStorage.getItem("nfs-panel-token") || ""
            };

            const references = {
                tokenInput: document.getElementById("tokenInput"),
                tokenStatus: document.getElementById("tokenStatus"),
                refreshButton: document.getElementById("refreshShares"),
                sharesBody: document.getElementById("sharesBody"),
                console: document.getElementById("console"),
                createMachine: document.getElementById("createMachine"),
                createFolder: document.getElementById("createFolder"),
                deleteMachine: document.getElementById("deleteMachine"),
                deleteFolder: document.getElementById("deleteFolder"),
                tokenForm: document.getElementById("tokenForm"),
                tokenClear: document.getElementById("limparToken"),
                createForm: document.getElementById("createForm"),
                deleteForm: document.getElementById("deleteForm")
            };

            references.tokenInput.value = state.token;
            updateTokenStatus();
            paintConsole("Interface pronta. Define um token e comeca a usar.\n");

            references.tokenForm.addEventListener("submit", function (event) {
                event.preventDefault();
                persistToken(references.tokenInput.value);
            });

            references.tokenClear.addEventListener("click", function () {
                persistToken("");
            });

            references.refreshButton.addEventListener("click", function () {
                listShares();
            });

            references.createForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const payload = {
                    machine_name: references.createMachine.value.trim(),
                    folder_path: references.createFolder.value.trim()
                };

                if (!validatePayload(payload, "criar")) {
                    return;
                }

                apiRequest("/nfs/create", { method: "POST", body: payload })
                    .then(function () {
                        paintConsole("[OK] Partilha criada com sucesso.\n");
                        copyToDelete(payload);
                        listShares();
                    })
                    .catch(handleError);
            });

            references.deleteForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const payload = {
                    machine_name: references.deleteMachine.value.trim(),
                    folder_path: references.deleteFolder.value.trim()
                };

                if (!validatePayload(payload, "remover")) {
                    return;
                }

                apiRequest("/nfs/delete", { method: "DELETE", body: payload })
                    .then(function () {
                        paintConsole("[DEL] Partilha removida com sucesso.\n");
                        listShares();
                    })
                    .catch(handleError);
            });

            function persistToken(rawToken) {
                state.token = rawToken.trim();
                if (state.token) {
                    localStorage.setItem("nfs-panel-token", state.token);
                    paintConsole("[TOKEN] Token guardado.\n");
                } else {
                    localStorage.removeItem("nfs-panel-token");
                    paintConsole("[ALERTA] Token limpo.\n");
                }
                references.tokenInput.value = state.token;
                updateTokenStatus();
            }

            function updateTokenStatus() {
                if (state.token) {
                    references.tokenStatus.textContent = "Token pronto para ser usado.";
                    references.tokenStatus.classList.remove("text-slate-500");
                    references.tokenStatus.classList.add("text-emerald-400");
                } else {
                    references.tokenStatus.textContent = "Token ainda nao definido.";
                    references.tokenStatus.classList.remove("text-emerald-400");
                    references.tokenStatus.classList.add("text-slate-500");
                }
            }

            function validatePayload(payload, action) {
                if (!payload.machine_name || !payload.folder_path) {
                    paintConsole("[ALERTA] Para " + action + " precisas de maquina e path.\n");
                    return false;
                }
                if (!state.token) {
                    paintConsole("[ALERTA] Define primeiro o token antes de chamar a API.\n");
                    return false;
                }
                return true;
            }

            function apiRequest(path, options) {
                const config = {
                    method: options.method || "GET",
                    headers: {
                        "Authorization": state.token
                    }
                };

                if (options.body) {
                    config.headers["Content-Type"] = "application/json";
                    config.body = JSON.stringify(options.body);
                }

                return fetch(path, config).then(async function (response) {
                    const text = await response.text();
                    let parsed;
                    try {
                        parsed = text ? JSON.parse(text) : null;
                    } catch (error) {
                        parsed = text;
                    }

                    if (!response.ok) {
                        const message = parsed && parsed.error ? parsed.error : (parsed || response.statusText);
                        throw new Error(message || "Erro inesperado");
                    }

                    return parsed;
                });
            }

            function listShares() {
                if (!state.token) {
                    paintConsole("[ALERTA] Define primeiro o token antes de pedir a lista.\n");
                    return;
                }

                paintConsole("[INFO] A pedir a lista de partilhas...\n");
                apiRequest("/nfs/list", { method: "GET" })
                    .then(function (shares) {
                        const cleanList = Array.isArray(shares) ? shares : [];
                        renderShares(cleanList);
                        paintConsole("[INFO] Recebidas " + cleanList.length + " partilhas.\n");
                    })
                    .catch(handleError);
            }

            function renderShares(shares) {
                if (!shares.length) {
                    references.sharesBody.innerHTML = "<tr><td colspan=\"4\" class=\"px-4 py-6 text-center text-xs text-slate-500\">Sem partilhas para mostrar.</td></tr>";
                    return;
                }

                references.sharesBody.innerHTML = shares.map(function (share) {
                    const safeMachine = escapeHTML(share.machine_name || share.machineName || "");
                    const safeFolder = escapeHTML(share.folder_path || share.folderPath || "");
                    const safeSource = escapeHTML(share.source || "");
                    const safeTarget = escapeHTML(share.target || "");
                    return "<tr class=\"share-row cursor-pointer transition hover:bg-slate-800/80\" data-machine=\"" + safeMachine + "\" data-folder=\"" + safeFolder + "\">" +
                        "<td class=\"px-4 py-3 text-sm text-slate-100\">" + safeMachine + "</td>" +
                        "<td class=\"px-4 py-3 text-sm text-slate-100\">" + safeFolder + "</td>" +
                        "<td class=\"px-4 py-3 text-sm text-slate-300\">" + safeSource + "</td>" +
                        "<td class=\"px-4 py-3 text-sm text-slate-300\">" + safeTarget + "</td>" +
                        "</tr>";
                }).join("");

                Array.from(references.sharesBody.querySelectorAll(".share-row")).forEach(function (row) {
                    row.addEventListener("click", function () {
                        const machine = row.getAttribute("data-machine");
                        const folder = row.getAttribute("data-folder");
                        references.createMachine.value = machine;
                        references.deleteMachine.value = machine;
                        references.createFolder.value = folder;
                        references.deleteFolder.value = folder;
                        paintConsole("[INFO] Selecionada partilha de " + machine + " para preencher os formularios.\n");
                    });
                });
            }

            function escapeHTML(value) {
                return String(value)
                    .replace(/&/g, "&amp;")
                    .replace(/"/g, "&quot;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            function copyToDelete(payload) {
                references.deleteMachine.value = payload.machine_name;
                references.deleteFolder.value = payload.folder_path;
            }

            function handleError(error) {
                paintConsole("[ERRO] " + (error && error.message ? error.message : error) + "\n");
            }

            function paintConsole(message) {
                references.console.textContent += message;
                references.console.scrollTop = references.console.scrollHeight;
            }

            if (state.token) {
                listShares();
            }
        })();
    </script>
</body>
</html>
